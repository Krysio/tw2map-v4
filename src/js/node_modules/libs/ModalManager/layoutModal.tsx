import * as React from 'react';
import { Hook, Header, Body, Footer } from '.';
import { findChildType } from './helper';

/******************************/

type ComponentProps = Readonly<{
    hook?: Hook,
    hideNotUnmount?: true,
    hideWhenInactive?: true,
    hidden?: true,
    spyCursor?: true,
    onClose?: () => void,
    key?: string,
    style?: React.CSSProperties,
    className?: string,
    children?: React.ReactNode
}>;
type ComponentState = Readonly<{}>

/******************************/

export default
class Modal
extends React.Component<
    ComponentProps,
    ComponentState
> {
    constructor(props) {
        super(props);
        this.onModalMouseDown = this.onModalMouseDown.bind(this);
        this.onMouseDown = this.onMouseDown.bind(this);
        this.onClose = this.onClose.bind(this);
    }

    /******************************/

    onModalMouseDown(
        e: React.MouseEvent
    ): void {
        this.props.hook.active();
    }

    onMouseDown(
        e: React.MouseEvent
    ): void {
        let { clientX: x, clientY: y } = e.nativeEvent;

        this.props.hook.moveStart(x, y);
    }

    onClose(): void {
        this.props.hook.close();

        if (this.props.onClose) {
            this.props.onClose();
        }
    }

    /******************************/

    getRootElement(): HTMLElement {
        return this.refs.root as HTMLElement;
    }

    getContainerElement(): HTMLElement {
        return this.refs.container as HTMLElement;
    }

    /******************************/

    componentDidMount(): void {
        this.props.hook.bindComponent(this);
    }

    componentWillUnmount(): void {
        this.props.hook.bindComponent(null);
    }

    shouldComponentUpdate(
        nextProps: ComponentProps,
        nextState: ComponentState
    ): boolean {
        if (this.props.hook.dirtyView) {
            return true;
        }

        return false;
    }

    componentDidUpdate(): void {
        this.props.hook.viewComponentHasBeenRendered();
    }

    /******************************/

    render(): JSX.Element {
        let hook = this.props.hook,
            state = hook.state,
            orientation: number = hook.state.orientation,
            modalClassList: string[] = ['modal', 'fade'];

        // set flag dirtyView
        hook.dirtyView = false;

        // add class if not hidden
        if (!state.hidden) {
            modalClassList.push('show');
        }

        if (this.props.className) {
            modalClassList.push(this.props.className);
        }

        modalClassList.push(`mode-${ orientation }`);

        return (
            <div
                ref="root"
                className={ modalClassList.join(' ') }
                style={{
                    display: state.hidden ? 'none' : 'block'
                }}
                onMouseDownCapture={ this.onModalMouseDown }
            >
                <div
                    ref="container"
                    className="modal-dialog"
                    style={ this.props.style || null }
                >
                    <div className="modal-content">
                        { this.renderHeader() }
                        { this.renderBody() }
                        { this.renderFooter() }
                    </div>
                </div>
            </div>
        );
    }

    renderHeader(): JSX.Element {
        let headerNode = findChildType(this.props.children, Header);

        if (React.isValidElement(headerNode)) {
            let classList = headerNode.props.className || '';

            return (
                <div
                    className={`modal-header${ classList ? ' '+ classList : '' }`}
                    style={ headerNode.props.style }
                    onMouseDown={ this.onMouseDown }
                >
                    { headerNode.props.children }
                    { this.renderCloseBtn() }
                </div>
            );
        }

        return null;
    }

    renderCloseBtn(): JSX.Element {
        return (
            <button
                type="button"
                className="close"
                onClick={ this.onClose }
            >
                <span></span>
            </button>
        );
    }

    renderBody(): JSX.Element {
        let bodyNode = findChildType(this.props.children, Body);

        if (React.isValidElement(bodyNode)) {
            let classList = bodyNode.props.className || '';

            return (
                <div
                    className={`modal-body${ classList ? ' '+ classList : '' }`}
                    style={ bodyNode.props.style }
                >
                    { bodyNode.props.children }
                </div>
            );
        }

        return null;
    }

    renderFooter(): JSX.Element {
        let footerNode = findChildType(this.props.children, Footer);

        if (React.isValidElement(footerNode)) {
            let classList = footerNode.props.className || '';

            return (
                <div
                    className={`modal-footer${ classList ? ' '+ classList : '' }`}
                    style={ footerNode.props.style }
                >
                    { footerNode.props.children }
                </div>
            );
        }

        return null;
    }
}