import Events from "map/Events";
import Item from "map/data/MapData/Item";
import Village from "map/data/MapData/Village";
import Character from "map/data/MapData/Character";
import BuffersManager from "map/data/BuffersManager";
import Renderer from "map/Renderer";
import {
    COLOR_INDEX_VILLAGE_PLAYER,
    COLOR_INDEX_HOVER_GROUP,
    COLOR_INDEX_VILLAGE_BARBARIAN,
    COLOR_INDEX_HOVER_ITEM
} from "map/data/mapColors";

/******************************/

export default function featureHoverItem(
    events: Events,
    buffersManager: BuffersManager,
    renderer: Renderer
): void {
    let hoveredItem: Item = null,
        hoveredGroup: Item = null;

    // hover item on map
    events.on('hover/item', (item: Item) => {
        let group: Item = null,
            flagUpdateBuffer = false;

        if (item instanceof Village) {
            group = item.character;
        } else if (item instanceof Character) {
            group = item.tribe;
        }

        // remove prev group hover
        if ((
                hoveredGroup !== group
                && hoveredGroup !== null
                && group !== null
            ) || (
                group === null
                && hoveredGroup !== null
            )
        ) {
            let villageList = hoveredGroup.getVillages();

            for (let village of villageList) {
                buffersManager.tileSetColorSlot(
                    village.x,
                    village.y,
                    COLOR_INDEX_VILLAGE_PLAYER // TODO self color
                );
            }

            flagUpdateBuffer = true;
        }

        // set group hover
        if (group !== hoveredGroup
            && group !== null
        ) {
            let villageList = group.getVillages();

            for (let village of villageList) {
                buffersManager.tileSetColorSlot(
                    village.x,
                    village.y,
                    COLOR_INDEX_HOVER_GROUP
                );
            }

            flagUpdateBuffer = true;
        }

        // prev hover to group hover
        if (group !== null
            && hoveredGroup === group
            && hoveredItem !== item
        ) {
            let villageList = hoveredItem.getVillages();

            for (let village of villageList) {
                buffersManager.tileSetColorSlot(
                    village.x,
                    village.y,
                    COLOR_INDEX_HOVER_GROUP
                );
            }

            flagUpdateBuffer = true;
        }

        // remove prev item hover
        if (hoveredItem !== null
            && hoveredItem !== item
            && (
                hoveredGroup !== group
                || (
                    hoveredGroup === null
                    && group === null
                )
            )
        ) {
            let villageList = hoveredItem.getVillages();

            for (let village of villageList) {
                buffersManager.tileSetColorSlot(
                    village.x,
                    village.y,
                    village.character
                        ? COLOR_INDEX_VILLAGE_PLAYER
                        : COLOR_INDEX_VILLAGE_BARBARIAN // TODO self color
                );
            }

            flagUpdateBuffer = true;
        }

        // set item hover
        if (item !== null) {
            let villageList = item.getVillages();

            for (let village of villageList) {
                buffersManager.tileSetColorSlot(
                    village.x,
                    village.y,
                    COLOR_INDEX_HOVER_ITEM
                );
            }

            flagUpdateBuffer = true;
        }

        hoveredItem = item;
        hoveredGroup = group;

        if (flagUpdateBuffer) {
            renderer.updateData(buffersManager.getDataBuffer());
        }
    });
}