import * as React from 'react';
import { CanvasApi } from 'canvas';
import { StoreMap } from 'stores';
import serviceColorPickerInit from 'view/services/serviceColorPicker';

import { map_index2color } from 'canvas/data/mapColors';

/******************************/

type ComponentProps = Readonly<{
    stores: StoreMap,
    mainCanvas: CanvasApi,
    serviceColorPicker: ReturnType<typeof serviceColorPickerInit>,
    children?: React.ReactNode
}>;
type ComponentState = Readonly<{}>

/******************************/

export default
class MapSettings
extends React.Component<ComponentProps, ComponentState> {
    unsubscriberList = [];

    /******************************/

    componentWillMount(): void {
        this.unsubscriberList.push(
            this.props.stores.global.subscribe(
                () => this.forceUpdate()
            )
        );
    }

    componentWillUnmount(): void {
        for (let unsubscriber of this.unsubscriberList) {
            unsubscriber();
        }
    }

    /******************************/

    render(): JSX.Element {
        let setColor = this.props.mainCanvas.commands.setColorInSlot,
            globalStore = this.props.stores.global,
            globalState = globalStore.getState(),
            cPick = this.props.serviceColorPicker;

        let list = [];
        for (let index in map_index2color) {
            let slot = parseInt(index),
                { key, label } = map_index2color[ index ],
                currentColor = globalState[ `map_${ key }` ];

            list.push(
                <div key={ key } className="form-group m-0 d-flex justify-content-between">
                    <label className="my-2">{ label }</label>
                    <div className="my-2 fx-ac">
                        <button
                            className="btn btn-dark btn-sm p-3 mx-2"
                            style={{
                                backgroundColor: currentColor
                            }}
                            onClick={(e) => {
                                cPick(
                                    currentColor,
                                    (color) => setColor(slot, color)
                                ).then(
                                    (color) => {
                                        globalStore.actions.setMapColor(key, color);
                                        this.forceUpdate();
                                    },
                                    (error) => setColor(slot, currentColor)
                                );
                            }}
                        ></button>
                    </div>
                </div>
            );
        }

        return (
            <div className="ofh">{ list }</div>
        );
    }
}