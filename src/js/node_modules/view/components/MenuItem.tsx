import * as React from 'react';
import debug from 'debug';
import Item from 'data/data/Item';
import Village from 'data/data/Village';
import Character from 'data/data/Character';
import Tribe from 'data/data/Tribe';
import { Hook } from 'libs/ModalManager';
import { ViewContext } from 'view/viewContext';
import { IconVillage, IconCharacter, IconTribe } from 'view/components/icon';

/******************************/

const debugLog = debug('app:view:menuItem');

/******************************/

type ComponentProps = Readonly<{
    hook: Hook,
    context: ViewContext,
    children?: React.ReactNode
}>;
type ComponentState = Readonly<{}>

/******************************/

export default
class MenuItem
extends React.Component<ComponentProps, ComponentState> {
    village: Village = null;
    character: Character = null;
    tribe: Tribe = null;
    item: Item = null;

    /******************************/

    markVillage = (
        e: React.MouseEvent
    ): void => {
        debugLog('markVillage', 'start');
        this.props.context.stores.world.actions.markMapItem(this.village);
        debugLog('markVillage', 'end');
        this.hideHook();
    }
    markCharacter = (
        e: React.MouseEvent
    ): void => {
        this.props.context.stores.world.actions.markMapItem(this.character);
        this.hideHook();
    }
    markTribe = (
        e: React.MouseEvent
    ): void => {
        this.props.context.stores.world.actions.markMapItem(this.tribe);
        this.hideHook();
    }
    infoVillage = (
        e: React.MouseEvent
    ): void => {
        this.props.context.services.itemInfo(this.village);
        this.hideHook();
    }
    infoCharacter = (
        e: React.MouseEvent
    ): void => {
        this.props.context.services.itemInfo(this.character);
        this.hideHook();
    }
    infoTribe = (
        e: React.MouseEvent
    ): void => {
        this.props.context.services.itemInfo(this.tribe);
        this.hideHook();
    }

    /******************************/

    onSomething = (): void => {
        this.hideHook();
    }

    onClickChange = (
        item: Item
    ): void => {
        if (item !== this.item) {
            this.item = item;

            if (item === null) {
                this.village = null;
                this.character = null;
                this.tribe = null;
                this.hideHook();
            } else {
                switch (item.mapItemType) {
                    case 'village':
                        this.village = item as Village;
                        this.character = this.village.character;
                        this.tribe = this.character && this.character.tribe;
                        break;
                    case 'character':
                        this.village = null;
                        this.character = item as Character;
                        this.tribe = this.character.tribe;
                        break;
                    case 'tribe':
                        this.village = null;
                        this.character = null;
                        this.tribe = item as Tribe;
                        break;
                }
                this.props.hook.setCursorPosition();
                this.showHook();
            }

            this.forceUpdate();
        } else if (this.item) {
            this.props.hook.setCursorPosition();
            this.showHook();
        }
    }

    hideHook() {
        this.props.hook.options.hideWhenInactive = true;
        this.props.hook.hide();
    }
    showHook() {
        this.props.hook.options.hideWhenInactive = false;
        this.props.hook.show();
    }

    /******************************/

    componentDidMount(): void {
        let events = this.props.context.mainCanvas.events;

        events.on('click/item', this.onClickChange);
        events.on('changed canvas/move', this.onSomething);
    }

    componentWillUnmount(): void {
        let events = this.props.context.mainCanvas.events;

        events.removeListener('click/item', this.onClickChange);
        events.removeListener('changed canvas/move', this.onSomething);
    }

    /******************************/

    render(): JSX.Element {
        this.props.hook.options.hideWhenInactive = false;

        let markButtons: JSX.Element[] = [],
            infoButtons: JSX.Element[] = [];

        // tworzenie przycisk√≥w

        if (this.village !== null) {
            let { name, x, y } = this.village;

            markButtons.push(
                <button
                    key="mv"
                    className="dropdown-item value-format"
                    onClick={ this.markVillage }
                >
                    <span className="special-char">
                        <IconVillage />
                    </span>
                    &nbsp;
                    { name }
                    &nbsp;
                    <span className="special-char">[</span>
                    <span className="value-1">{ x }</span>
                    <span className="special-char">|</span>
                    <span className="value-1">{ y }</span>
                    <span className="special-char">]</span>
                </button>
            );
            infoButtons.push(
                <button
                    key="iv"
                    className="dropdown-item value-format"
                    onClick={ this.infoVillage }
                >
                    <span className="special-char">
                        <IconVillage />
                    </span>
                    &nbsp;
                    { name }
                    &nbsp;
                    <span className="special-char">[</span>
                    <span className="value-1">{ x }</span>
                    <span className="special-char">|</span>
                    <span className="value-1">{ y }</span>
                    <span className="special-char">]</span>
                </button>
            );
        }

        if (this.character !== null) {
            markButtons.push(
                <button
                    key="mc"
                    className="dropdown-item value-format"
                    onClick={ this.markCharacter }
                >
                    <span className="special-char">
                        <IconCharacter />
                    </span>
                    &nbsp;
                    { this.character.name }
                </button>
            );
            infoButtons.push(
                <button
                    key="ic"
                    className="dropdown-item value-format"
                    onClick={ this.infoCharacter }
                >
                    <span className="special-char">
                        <IconCharacter />
                    </span>
                    &nbsp;
                    { this.character.name }
                </button>
            );
        }

        if (this.tribe !== null) {
            markButtons.push(
                <button
                    key="mt"
                    className="dropdown-item value-format"
                    onClick={ this.markTribe }
                >
                    <span className="special-char">
                        <IconTribe />
                    </span>
                    &nbsp;
                    { this.tribe.name }
                    &nbsp;
                    <span className="special-char">[</span>
                    <span className="value-2">{ this.tribe.tag }</span>
                    <span className="special-char">]</span>
                </button>
            );
            infoButtons.push(
                <button
                    key="it"
                    className="dropdown-item value-format"
                    onClick={ this.infoTribe }
                >
                    <span className="special-char">
                        <IconTribe />
                    </span>
                    &nbsp;
                    { this.tribe.name }
                    &nbsp;
                    <span className="special-char">[</span>
                    <span className="value-2">{ this.tribe.tag }</span>
                    <span className="special-char">]</span>
                </button>
            );
        }

        return (
            <div className="dropdown-menu show position-static">
                <h6 className="dropdown-header text-success">Mark</h6>
                { markButtons }
                <h6 className="dropdown-header text-info">Info</h6>
                { infoButtons }
            </div>
        );
    }
}
