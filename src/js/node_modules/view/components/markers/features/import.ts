import { ViewContext } from 'view/viewContext';
import { safeParsePackage } from 'view/services/package';

/******************************/

export default async function featureImport(
    context: ViewContext
) {
    const worldStore = context.stores.world;
    const worldState = worldStore.getState();
    const markersState = worldState.getMarkers();
    const activePackage = markersState.getActivePackage();

    let code;

    try {
        code = await context.services.prompt(
            'Paste a package code here',
            '',
            8
        );
    } catch (error) {
        /* cancel */
        return;
    }

    let data;

    try {
        data = JSON.parse(code);
    } catch (error) {
        alert('Error: Invalid code');
        return;
    }

    const newPackage = safeParsePackage(data);

    try {
        const newName = await context.services.prompt(
            'Rename the package',
            newPackage.name
        );

        newPackage.name = newName;
    } catch (error) {/* cancel */}

    worldStore.actions.packageAdd(newPackage);
}