import * as React from 'react';
import { Hook } from 'libs/ModalManager';
import { ViewContext } from 'view/viewContext';
import Marker from 'view/components/markers/Marker';

/******************************/

type ComponentProps = Readonly<{
    hook: Hook,
    context: ViewContext,
    updateModal: () => void,
    children?: React.ReactNode
}>;
type ComponentState = Readonly<{}>

/******************************/

export default
class MarkersModalBody
extends React.Component<
    ComponentProps,
    ComponentState
> {

    /******************************/

    unsubscriberList = [];

    componentDidMount(): void {
        let previousStore = null;

        this.unsubscriberList.push(
            this.props.context.stores.world.subscribe(
                () => {
                    const worldState = this.props.context.stores.world.getState();

                    if (previousStore === null
                        || worldState.markers !== previousStore.markers
                    ) {
                        this.forceUpdate();
                        previousStore = worldState;
                    }
                }
            )
        );
        this.forceUpdate();
    }

    componentWillUnmount(): void {
        let unsubscriber;

        while (unsubscriber = this.unsubscriberList.pop()) {
            unsubscriber();
        }
    }

    componentDidUpdate(): void {
        this.props.updateModal();
    }

    /******************************/

    render(): JSX.Element {
        let worldState = this.props.context.stores.world.getState(),
            markersState = worldState.getMarkers(),
            activePackage = markersState.getActivePackage(),
            rootMarker = activePackage.getRootMarker();

        return (
            <div>
                <Marker
                    context={ this.props.context }
                    marker={ rootMarker }
                    package={ activePackage }
                />
            </div>
        );
    }
}